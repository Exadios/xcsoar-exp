#!/usr/bin/python3

import socket, sched, time

localIP = "127.0.0.1"
localPort = 20001

UDPSocket = socket.socket(family=socket.AF_INET, type=socket.SOCK_DGRAM)

heartbeat = bytearray(b'\x7e\x00\x81\x00\x31\x38\x00\x00\x73\x2a\x7e')
target_heartbeat_ownship_altitude = \
bytearray(b'\x7e\x14\x00\x7c\x17\x61\xe8\x78\xfb\x54\x8d\xe5\x4b\x09\x99\x11\x30\x00\x4a\x01\x45\x57\x4a\x20\x20\x20\x20\x20\x06\x88\x49\x7e\x7e\x00\x81\x00\x63\x39\x00\x00\x8f\x52\x7e\x7e\x0a\x00\x7c\x20\xe8\xe8\x95\xf7\x53\x41\x6d\x04\x38\x68\x00\x00\x00\x00\x09\x47\x53\x41\x00\x00\x00\x00\x00\x00\x5f\x8c\x7e\x7e\x0b\x00\xc8\x00\x15\xa0\xa8\x7e')
target_target_ahrs = \
bytearray(b'\x7e\x14\x00\x7c\x17\x61\xe8\x78\xf5\x54\x8d\xff\x4b\x09\x99\x11\x30\x00\x4a\x01\x45\x57\x4a\x20\x20\x20\x20\x20\x06\x50\x4f\x7e\x7e\x14\x00\x7c\x80\x0d\xe8\xb1\x50\x53\x4d\x82\x16\xc9\x88\x08\xe0\x00\xf5\x01\x5a\x4b\x56\x20\x20\x20\x20\x20\x06\xf0\x0c\x7e\x7e\x65\x00\x01\x00\x00\x00\x00\x17\x0c\xe7\x17\x53\x6b\x79\x45\x63\x68\x6f\x00\x53\x6b\x79\x45\x63\x68\x6f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14\xbc\x7e')
heartbeat_ownship_altitude = \
bytearray(b'\x7e\x00\x81\x00\x62\x39\x00\x00\xbe\x61\x7e\x7e\x0a\x00\x7c\x20\xe8\xe8\x95\xf7\x53\x41\x6d\x04\x38\x68\x00\x00\x00\x00\x09\x47\x53\x41\x00\x00\x00\x00\x00\x00\x5f\x8c\x7e\x7e\x0b\x00\xc8\x00\x15\xa0\xa8\x7e')
target_ahrs = \
bytearray(b'\x7e\x14\x00\x7c\x80\x0d\xe8\xb1\x32\x53\x4d\x8c\x16\xc9\x88\x08\xe0\x00\xf5\x01\x5a\x4b\x56\x20\x20\x20\x20\x20\x06\x1f\xd0\x7e\x7e\x65\x00\x01\x00\x00\x00\x00\x17\x0c\xe7\x17\x53\x6b\x79\x45\x63\x68\x6f\x00\x53\x6b\x79\x45\x63\x68\x6f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x14\xbc\x7e')
target = \
bytearray(b'\x7e\x14\x00\x7c\x17\x61\xe8\x79\x08\x54\x8d\x9f\x4b\x09\x99\x11\x30\x00\x4a\x01\x45\x57\x4a\x20\x20\x20\x20\x20\x06\xbb\xb5\x7e')

s = sched.scheduler(time.time, time.sleep)

def send_target_heartbeat_ownship_altitude(a = 'buffer'):
    UDPSocket.sendto(target_heartbeat_ownship_altitude, (localIP, 4000))
def send_target_target_ahrs(a = 'buffer'):
    UDPSocket.sendto(target_target_ahrs, (localIP, 4000))
def send_heartbeat_ownship_altitude(a = 'buffer'):
    UDPSocket.sendto(heartbeat_ownship_altitude, (localIP, 4000))
def send_target_ahrs(a = 'buffer'):
    UDPSocket.sendto(target_ahrs, (localIP, 4000))
def send_target(a = 'buffer'):
    UDPSocket.sendto(target, (localIP, 4000))

def runner():
    t0 = time.time()
    seconds = 0
    while(True):
        seconds += 1
        print("Setting up packet at ", t0 + seconds)
        s.enterabs(t0 + seconds, 1, send_heartbeat_ownship_altitude)
        s.enterabs(t0 + seconds + 0.140, 1, send_target)
        s.enterabs(t0 + seconds + 0.345, 1, send_target_ahrs)
        s.enterabs(t0 + seconds + 0.942, 1, send_target_heartbeat_ownship_altitude)
        s.run()

runner()
